---
import { Picture } from "astro:assets";

import Icon from "./Icon.astro";
import Surface from "./Surface.astro";
import type { GalleryImage } from "../lib/site";

type Props = {
  /** Eindeutige ID, damit mehrere Galerien auf einer Seite möglich sind */
  id: string;
  images: GalleryImage[];
  /** Optionaler Text, der im Lightbox-Footer angezeigt wird */
  label?: string;
};

const { id, images, label = "" } = Astro.props as Props;

const rootId = `lb-${id}`;
const stripId = `${rootId}-strip`;
const modalId = `${rootId}-modal`;
const imgId = `${rootId}-img`;
const captionId = `${rootId}-cap`;
const captionSubId = `${rootId}-cap-sub`;
const countId = `${rootId}-count`;
const closeId = `${rootId}-close`;
const prevId = `${rootId}-prev`;
const nextId = `${rootId}-next`;
const scrollLeftId = `${rootId}-scroll-left`;
const scrollRightId = `${rootId}-scroll-right`;
---

<div id={rootId} class="relative" data-lightbox-root data-lb-label={label}>
  <!-- Carousel-Leiste -->
  <div class="relative mt-6">
    <div class="relative">
      <!-- Kanten-Fade (dezent) -->
      <div aria-hidden="true" class="pointer-events-none absolute inset-y-0 left-0 w-10 bg-gradient-to-r from-bg via-bg/70 to-transparent"></div>
      <div aria-hidden="true" class="pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-bg via-bg/70 to-transparent"></div>

      <div
        id={stripId}
        data-lb-strip
        class="no-scrollbar flex gap-4 overflow-x-auto scroll-smooth snap-x snap-mandatory pb-2">
        {images.map((img, i) => (
          <Surface
            as="button"
            type="button"
            variant="soft"
            class="reveal group relative snap-start shrink-0 overflow-hidden"
            style={`--reveal-delay: ${Math.min(i * 55, 220)}ms`}
            data-lb-open
            data-index={i}
            data-src={img.src}
            data-alt={img.alt}
            data-caption={img.caption ?? ""}
            aria-label={`Bild ${i + 1} ansehen`}
          >
            <Picture
              src={img.asset}
              alt={img.alt}
              widths={[280, 340, 380, 760]}
              sizes="(min-width: 1024px) 380px, (min-width: 640px) 340px, 280px"
              formats={["avif", "webp"]}
              quality={80}
              loading="lazy"
              decoding="async"
              class="h-[210px] w-[280px] sm:h-[240px] sm:w-[340px] lg:h-[260px] lg:w-[380px] object-cover transition-transform duration-300 group-hover:scale-[1.02]"
            />
            <div aria-hidden="true" class="absolute inset-0 bg-gradient-to-t from-black/40 via-black/0 to-black/0 opacity-70"></div>
            <div class="absolute left-3 bottom-3 flex items-center gap-2 rounded-full border border-border/70 bg-bg/40 backdrop-blur px-3 py-1 text-xs text-text/90">
              <Icon name="zoom-in" size={14} class="text-text/80" />
              <span>Ansehen</span>
            </div>
          </Surface>
        ))}
      </div>
    </div>

    <!-- Carousel-Steuerung -->
    <div class="mt-4 flex items-center justify-between">
      <div class="text-xs text-muted tabular-nums">{images.length} Fotos</div>
      <div class="flex items-center gap-2">
        <Surface
          as="button"
          variant="control"
          id={scrollLeftId}
          data-lb-scroll-left
          type="button"
          class="inline-flex items-center justify-center h-9 w-9"
          aria-label="Nach links scrollen"
        >
          <Icon name="chevron-left" size={18} class="text-muted" />
        </Surface>
        <Surface
          as="button"
          variant="control"
          id={scrollRightId}
          data-lb-scroll-right
          type="button"
          class="inline-flex items-center justify-center h-9 w-9"
          aria-label="Nach rechts scrollen"
        >
          <Icon name="chevron-right" size={18} class="text-muted" />
        </Surface>
      </div>
    </div>
  </div>

  <!-- Lightbox / Modal -->
  <div
    id={modalId}
    data-lb-modal
    class="fixed inset-0 z-[100] hidden items-center justify-center p-4"
    role="dialog"
    aria-modal="true"
    aria-label="Bildanzeige"
  >
    <div data-lb-overlay class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>

    <div class="relative w-full max-w-5xl">
      <Surface variant="glass" class="mx-auto overflow-hidden">
        <div class="flex items-center justify-between gap-4 px-4 py-3 border-b border-border/70">
          <div class="flex items-center gap-3 min-w-0">
            <div id={countId} data-lb-count class="text-xs text-muted tabular-nums">&nbsp;</div>
            {label ? <div class="hidden sm:block text-xs text-muted truncate">{label}</div> : null}
          </div>
          <Surface
            as="button"
            variant="control"
            id={closeId}
            data-lb-close
            type="button"
            class="inline-flex items-center gap-2 px-3 py-2"
            aria-label="Schließen"
          >
            <Icon name="x" size={18} class="text-muted" />
            <span class="hidden sm:inline text-sm text-muted">Schließen</span>
          </Surface>
        </div>

        <div class="relative">
          <img
            id={imgId}
            data-lb-img
            alt=""
            class="block w-full max-h-[78vh] object-contain bg-bg/30"
          />

          <!-- Vor/Zurück -->
          <Surface
            as="button"
            variant="overlayControl"
            id={prevId}
            data-lb-prev
            type="button"
            class="absolute left-3 top-1/2 -translate-y-1/2 inline-flex items-center justify-center h-10 w-10"
            aria-label="Vorheriges Bild"
          >
            <Icon name="chevron-left" size={20} class="text-text/80" />
          </Surface>
          <Surface
            as="button"
            variant="overlayControl"
            id={nextId}
            data-lb-next
            type="button"
            class="absolute right-3 top-1/2 -translate-y-1/2 inline-flex items-center justify-center h-10 w-10"
            aria-label="Nächstes Bild"
          >
            <Icon name="chevron-right" size={20} class="text-text/80" />
          </Surface>
        </div>

        <div class="px-4 py-3 border-t border-border/70">
          <div class="flex flex-col gap-1">
            <div id={captionId} data-lb-caption class="text-sm font-[var(--w-title)] text-text leading-relaxed">&nbsp;</div>
            <div id={captionSubId} data-lb-caption-sub class="text-xs text-muted leading-relaxed">&nbsp;</div>
          </div>
          <div class="mt-2 text-[11px] text-muted/80">Tipp: Pfeiltasten wechseln · Esc schließt</div>
        </div>
      </Surface>
    </div>
  </div>
</div>