---
type Props = {
  /** Minecraft Java Server Address (hostname[:port]) */
  address: string;
  /** Optional label shown above */
  label?: string;
};

const { address, label = "Spieler online" } = Astro.props as Props;

// API docs: https://api.mcsrvstat.us (version 3)
const apiUrl = `https://api.mcsrvstat.us/3/${address}`;

// Unique IDs per component instance
const idBase = `mc-${Math.random().toString(16).slice(2)}`;
const valueId = `${idBase}-value`;
const dotId = `${idBase}-dot`;
const textId = `${idBase}-text`;
---

<div class="space-y-1">
  <div class="meta">{label}</div>
  <div class="flex items-center gap-2">
    <span id={dotId} aria-hidden="true" class="h-2 w-2 rounded-full bg-border"></span>
    <span id={valueId} class="tabular-nums text-text">…</span>
    <span id={textId} class="text-muted text-xs"></span>
  </div>
</div>

<script define:vars={{ apiUrl, valueId, dotId, textId }}>
  (() => {
    const valueEl = document.getElementById(valueId);
    const dotEl = document.getElementById(dotId);
    const textEl = document.getElementById(textId);
    if (!valueEl || !dotEl || !textEl) return;

    const setState = (state, valueText, infoText = "") => {
      // state: "online" | "offline" | "unknown"
      dotEl.classList.remove("bg-emerald-500/80", "bg-red-500/80", "bg-border");
      if (state === "online") dotEl.classList.add("bg-emerald-500/80");
      else if (state === "offline") dotEl.classList.add("bg-red-500/80");
      else dotEl.classList.add("bg-border");

      valueEl.textContent = valueText;
      textEl.textContent = infoText;
    };

    const fmtPlayers = (online, max) => {
      if (typeof online === "number" && typeof max === "number") return `${online}/${max}`;
      if (typeof online === "number") return String(online);
      return "–";
    };

    const fetchStatus = async () => {
      try {
        const res = await fetch(apiUrl, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // API v3: "online" boolean. When online, players.online/max available.
        if (data?.online) {
          const online = data?.players?.online;
          const max = data?.players?.max;
          setState("online", fmtPlayers(online, max), "online");
          return;
        }

        if (data?.online === false) {
          setState("offline", "0", "offline");
          return;
        }

        setState("unknown", "–", "nicht verfügbar");
      } catch (e) {
        setState("unknown", "–", "nicht verfügbar");
      }
    };

    fetchStatus();
    // Refresh every ~2 minutes (mcsrvstat.us is cached anyway)
    setInterval(fetchStatus, 120000);
  })();
</script>
