---
// Hinweis: Theme-Badge ist aktuell deaktiviert (Design bleibt vorerst fest).

type NavLink = { label: string; href: string; targetId?: string };

type Props = {
  brand?: string;
  links: NavLink[];
};

const { brand = "falkner.info", links } = Astro.props as Props;
---
<header class="sticky top-0 z-50">

  <div class="relative border-b border-border/70 bg-bg/55 backdrop-blur-xl supports-[backdrop-filter]:bg-bg/40">

    <div class="mx-auto max-w-6xl px-5 py-4 flex items-center justify-between gap-4">
      <a href="/" class="flex items-center gap-3 group" aria-label="Zur Startseite">
        <img
          src="/icons/android-chrome-192x192.png"
          width="28"
          height="28"
          alt=""
          decoding="async"
          class="rounded-sm border border-border/70 group-hover:border-border transition-colors" />
        <div class="leading-none">
          <div class="text-sm font-[450] tracking-tight">{brand}</div>
          <div class="meta mt-1">Persönliche Website · Einblicke & Links</div>
        </div>
      </a>

      <!-- Desktop-Navigation -->
      <nav class="hidden md:flex items-center gap-1" aria-label="Navigation">
        {links.map((l) => (
          <a
            href={l.href}
            data-nav-link
            data-target={l.targetId || ""}
            class="navlink px-3 py-2 text-sm text-muted hover:text-text transition-colors">
            {l.label}
          </a>
        ))}
        <!-- (bewusst entfernt) -->
      </nav>

      <!-- Mobile-Menü Button -->
      <button
        type="button"
        id="menuBtn"
        class="md:hidden inline-flex items-center justify-center rounded-md border border-border/70 bg-surface/60 px-3 py-2 text-sm text-text hover:bg-surface/80 transition"
        aria-label="Menü öffnen"
        aria-expanded="false"
        aria-controls="mobileMenu">
        Menü
      </button>
    </div>
  </div>

  <!-- Mobile Overlay-Menü (Navbar bleibt stabil) -->
  <div
    id="mobileMenu"
    class="fixed inset-0 z-[60] hidden"
    aria-hidden="true"
    role="dialog"
    aria-modal="true"
    aria-label="Navigation"
    tabindex="-1">
    <div id="menuOverlay" class="absolute inset-0 bg-bg/60 backdrop-blur-2xl"></div>
    <div class="absolute right-0 top-0 h-full w-full max-w-md border-l border-border/70 bg-bg/80 backdrop-blur-2xl">
      <div class="p-5">
        <div class="flex items-center justify-between">
          <div class="meta">Navigation</div>
          <button
            type="button"
            id="menuClose"
            class="rounded-md border border-border/70 bg-surface/60 px-3 py-2 text-sm hover:bg-surface/80"
            aria-label="Menü schließen">
            Schließen
          </button>
        </div>

        <div class="mt-6 space-y-1">
          {links.map((l) => (
            <a
              href={l.href}
              class="block rounded-md px-3 py-3 text-base text-text border border-transparent hover:border-border/70 hover:bg-surface/50 transition"
              data-mobile-link>
              <span class="font-[450]">{l.label}</span>
              <span class="block mt-1 text-sm text-muted">{l.href}</span>
            </a>
          ))}
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    const scrollLock = window.__scrollLock;
    const lockScroll = () => scrollLock?.lock?.();
    const unlockScroll = () => scrollLock?.unlock?.();

    const prefersReduced = window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches;

    // --- Mobile Menü ---
    const menu = document.getElementById("mobileMenu");
    const btn = document.getElementById("menuBtn");
    const closeBtn = document.getElementById("menuClose");
    const overlay = document.getElementById("menuOverlay");

    let isOpen = false;
    let lastFocused = null;

    const getFocusables = () => {
      if (!menu) return [];
      return Array.from(
        menu.querySelectorAll(
          'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])'
        )
      );
    };

    const trapTab = (e) => {
      if (!isOpen || e.key !== "Tab") return;
      const focusables = getFocusables();
      if (!focusables.length) return;

      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      const active = document.activeElement;

      if (e.shiftKey && active === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && active === last) {
        e.preventDefault();
        first.focus();
      }
    };

    const onKey = (e) => {
      if (!isOpen) return;
      if (e.key === "Escape") {
        e.preventDefault();
        close();
        return;
      }
      trapTab(e);
    };

    const open = () => {
      if (!menu || !btn) return;
      if (isOpen) return;
      isOpen = true;

      lastFocused = document.activeElement;

      menu.classList.remove("hidden");
      menu.setAttribute("aria-hidden", "false");
      btn.setAttribute("aria-expanded", "true");
      btn.setAttribute("aria-label", "Menü schließen");

      // Scroll-Lock (refcount, damit Lightbox & Menü nicht kollidieren)
      lockScroll();

      // Fokus sinnvoll setzen
      const focusables = getFocusables();
      (focusables.find((el) => el.id === "menuClose") ?? focusables[0] ?? menu).focus();

      window.addEventListener("keydown", onKey);
    };

    const close = () => {
      if (!menu || !btn) return;
      if (!isOpen) return;
      isOpen = false;

      menu.classList.add("hidden");
      menu.setAttribute("aria-hidden", "true");
      btn.setAttribute("aria-expanded", "false");
      btn.setAttribute("aria-label", "Menü öffnen");

      unlockScroll();
      window.removeEventListener("keydown", onKey);

      // Fokus wiederherstellen
      if (lastFocused && typeof lastFocused.focus === "function") lastFocused.focus();
    };

    btn?.addEventListener("click", () => (isOpen ? close() : open()));
    closeBtn?.addEventListener("click", close);
    overlay?.addEventListener("click", close);

    // Nach Klick auf einen Link schließen
    menu?.querySelectorAll("[data-mobile-link]").forEach((a) => a.addEventListener("click", close));

    // --- Aktiven Abschnitt markieren (IntersectionObserver) ---
    const links = Array.from(document.querySelectorAll("[data-nav-link]"));
    const sections = links
      .map((a) => a.getAttribute("data-target"))
      .filter(Boolean)
      .map((id) => document.getElementById(id));

    if ("IntersectionObserver" in window && sections.length) {
      const setActive = (id) => {
        links.forEach((a) => {
          const match = a.getAttribute("data-target") === id;
          a.setAttribute("data-active", match ? "true" : "false");
          if (match) a.setAttribute("aria-current", "true");
          else a.removeAttribute("aria-current");
        });
      };

      const obs = new IntersectionObserver(
        (entries) => {
          // Die sichtbarste Sektion gewinnt
          const visible = entries
            .filter((e) => e.isIntersecting)
            .sort((a, b) => (b.intersectionRatio || 0) - (a.intersectionRatio || 0));
          if (visible[0]?.target?.id) setActive(visible[0].target.id);
        },
        {
          root: null,
          rootMargin: "-20% 0px -65% 0px",
          threshold: prefersReduced ? 0.1 : [0.1, 0.2, 0.35, 0.5]
        }
      );

      sections.forEach((s) => s && obs.observe(s));
    }
  </script>

  <style>
    /* Minimalistischer Active-State: kleine Unterstreichung */
    :global(a.navlink[data-active="true"]) {
      color: hsl(var(--text) / 1);
      position: relative;
    }
    :global(a.navlink[data-active="true"]::after) {
      content: "";
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 6px;
      height: 1px;
      background: hsl(var(--accent) / 0.65);
      transform-origin: left;
      animation: line-in 700ms ease-out both;
    }
    @media (prefers-reduced-motion: reduce) {
      :global(a.navlink[data-active="true"]::after) {
        animation: none;
      }
    }
  </style>
</header>
