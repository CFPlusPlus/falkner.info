---
import Divider from "./Divider.astro";
import Button from "./Button.astro";
import Icon from "./Icon.astro";
import { site, socialLinks } from "../lib/site";
import { iconForLabel } from "../lib/icons";

const year = new Date().getFullYear();

// Base-URL (wichtig, wenn die Seite in einem Unterordner deployed wird)
const baseUrl = import.meta.env.BASE_URL;
const withBase = (href: string) =>
  href.startsWith("/") && !href.startsWith(baseUrl) ? `${baseUrl}${href.slice(1)}` : href;


// Build-Info (letzter Commit) für den Footer
const gitHash = (import.meta.env.GIT_COMMIT_HASH || "").trim();
const rawRepoUrl = (import.meta.env.PUBLIC_REPO_URL || "").trim();

// Repo-URL für Links normalisieren (Trailing Slash + .git entfernen)
// Wichtig: wir unterstützen hier bewusst nur GitHub.
const repoUrl = (() => {
  const candidate = rawRepoUrl.replace(/\.git$/i, "").replace(/\/+$/, "");
  if (!candidate) return "";
  try {
    const u = new URL(candidate);
    const host = u.hostname.toLowerCase();
    const isGitHub = host === "github.com" || host === "www.github.com";
    if (!isGitHub) return "";

    // Tracking entfernen
    u.search = "";
    u.hash = "";

    // Trailing Slash im Pfad entfernen
    if (u.pathname.length > 1) u.pathname = u.pathname.replace(/\/+$/, "");

    return u.toString();
  } catch {
    return "";
  }
})();

const repoLabel = (() => {
  if (!repoUrl) return "";
  try {
    const u = new URL(repoUrl);
    const path = u.pathname.replace(/^\/+|\/+$/g, "");
    // Für GitHub-URLs: "owner/repo" anzeigen
    return path || u.hostname;
  } catch {
    // Fallback: Protokoll entfernen
    return repoUrl.replace(/^https?:\/\//, "");
  }
})();

const commitUrl = repoUrl && gitHash ? `${repoUrl}/commit/${gitHash}` : "";

const footerLinks = (() => {
  const links = [...socialLinks];
  // Interne Legal-Links (bewusst im Footer sichtbar)
  const legal = [
    { label: "Impressum", href: "/impressum" },
    { label: "Datenschutz", href: "/datenschutz" },
  ];

  const xboxIndex = links.findIndex((l) =>
    l.label.toLowerCase().includes("xbox"),
  );
  if (xboxIndex >= 0) links.splice(xboxIndex + 1, 0, ...legal);
  else links.push(...legal);

  return links;
})();

---

<footer class="border-t border-border/70 bg-bg/40">
  <div class="mx-auto max-w-6xl px-5 py-16">
    <div class="grid gap-10 sm:grid-cols-[1.2fr_0.8fr]">
      <div class="reveal">
        <div class="meta">Info</div>
        <h2 class="mt-2 text-2xl font-[var(--w-title)] tracking-tight">
          Privates Webprojekt
        </h2>
        <p class="mt-4 text-muted leading-relaxed">
          Eine moderne, schnelle und bewusst schlanke Seite — ohne Tracking. Rechtliche Infos findest du unter <a class="u-link-muted" href={withBase("/impressum")}>Impressum</a> und <a class="u-link-muted" href={withBase("/datenschutz")}>Datenschutz</a>.
        </p>

        <div class="mt-6 flex flex-wrap gap-3">
          <Button href="/#contact" variant="ghost">Kontakt</Button>
        </div>
      </div>



      <div class="reveal" style="--reveal-delay: 90ms">
        <div class="meta">Links</div>
        <Divider class="mt-3" />

        <div class="mt-6 border-t border-border/70">
          {
            footerLinks.map((l, i) => (
              <a
                href={withBase(l.href)}
                target={l.href.startsWith("/") ? undefined : "_blank"}
                rel={l.href.startsWith("/") ? undefined : "noopener"}
                class="group w-full flex items-center justify-between gap-4 py-4 border-b border-border/70 hover:bg-surface/30 transition reveal"
                style={`--reveal-delay: ${Math.min(i * 40, 160)}ms`}
              >
                <div class="flex items-center gap-3 min-w-0 flex-1 overflow-hidden">
                  <Icon
                    name={iconForLabel(l.label)}
                    size={18}
                    class="text-muted group-hover:text-text transition-colors"
                  />
                  <div class="min-w-0 flex-1">
                    <div class="text-sm font-[var(--w-title)] text-text">{l.label}</div>
                    <div class="text-xs text-muted truncate hidden sm:block">
                      {l.href}
                    </div>
                  </div>
                </div>
                <Icon
                  name="arrow-up-right"
                  size={16}
                  class="text-muted group-hover:text-text transition-colors"
                />
              </a>
            ))
          }
        </div>

        <div class="mt-8">
          <Button href="/" variant="ghost">Zur Startseite</Button>
        </div>
      </div>
    </div>

    <Divider class="mt-12" />

<div class="mt-8 flex flex-col gap-3">
  {/* Linksbündig */}
  <p class="text-sm text-muted text-left">
    © {year} {site.author} — Alle Rechte vorbehalten.
  </p>

  {/* Rechtsbündig */}
  <div class="flex flex-col items-end text-right gap-2">
    <p class="text-sm text-muted">
      <span class="inline-flex items-center justify-end gap-1">
        <span>Handmade with</span>
        <span class="group inline-flex items-center">
          <Icon
            name="heart"
            size={14}
            class="text-muted transition-colors duration-200 group-hover:text-red-500"
          />
        </span>
        <span>in DE</span>
      </span>
    </p>

    {
      gitHash ? (
        <p class="text-xs text-muted">
          {repoUrl ? (
            <>
              <a
                class="font-[var(--w-title)] u-link-muted"
                href={repoUrl}
                target="_blank"
                rel="noopener"
              >
                {repoLabel}
              </a>
              {" @ "}
              <a
                class="font-[var(--w-title)] u-link-muted"
                href={commitUrl}
                target="_blank"
                rel="noopener"
              >
                {gitHash}
              </a>
            </>
          ) : (
            <>
              <span class="font-[var(--w-title)] text-text/80">Build</span>
              {" @ "}
              <span class="font-[var(--w-title)] text-text/80">{gitHash}</span>
            </>
          )}
        </p>
      ) : null
    }
  </div>
</div>



  </div>
</footer>

