---
// Tabler Icons (SVG Sprite)
//
// Für ein "dünneres" Icon-Design verwenden wir kein Webfont-Glyph,
// sondern ein SVG-Sprite. Das erlaubt uns, die Strichstärke (stroke-width)
// pro Icon zu steuern.
//
// WICHTIG: Kein <link rel="preload"> fürs Sprite.
// Browser können extern referenzierte Sprite-SVGs (via <use href="sprite.svg#id">)
// aktuell nicht zuverlässig aus dem Preload-Cache wiederverwenden.
// Ergebnis: Chrome/Safari warnen („preloaded but not used“) und teils wird
// die Datei sogar doppelt geladen. Deshalb lassen wir das Preload bewusst weg.

// Fonts (lokal gehostet via Fontsource)
// Headlines: Space Grotesk
// Body/UI: Geist Sans
import "@fontsource-variable/space-grotesk";
// Geist Sans ist bei Fontsource aktuell als statische Familie verfügbar.
// Deshalb importieren wir die benötigten Gewichte explizit.
import "@fontsource/geist-sans/300.css";
import "@fontsource/geist-sans/400.css";
import "@fontsource/geist-sans/500.css";
import "@fontsource/geist-sans/600.css";

import "../styles/global.css";
import { site, sameAsLinks } from "../lib/site";
import JsonLd from "../components/JsonLd.astro";
import { buildPersonJsonLd, buildWebPageJsonLd, buildWebSiteJsonLd } from "../lib/jsonld";

type Props = {
  title?: string;
  description?: string;
  canonicalPath?: string;
  ogImagePath?: string;
  /** Zusätzliche (oder alternative) JSON-LD Daten für Spezialfälle.
   *  Wenn du hier etwas übergibst, werden die Standard-Schemas trotzdem ergänzt.
   */
  jsonLd?: unknown | unknown[];
};

const {
  title = site.title,
  description = site.description,
  canonicalPath = "/",
  // Statt eines großen OG-Bildes nutzen wir standardmäßig das Logo-Icon
  ogImagePath = "/icons/android-chrome-512x512.png"
} = Astro.props as Props;

// Hinweis: Above-the-fold Bilder setzen wir direkt am <Image /> mit `priority`.

const canonicalUrl = new URL(canonicalPath, site.canonicalBase).toString();
// OG-Bild: Standardmäßig Logo-Icon, kann aber pro Seite via `ogImagePath` überschrieben werden.
const ogImageUrl = new URL(ogImagePath, Astro.site).toString();

// JSON-LD: Basis-Schemas (WebSite + Organization) und pro Seite ein WebPage-Schema
const baseSchemas = [
  buildWebSiteJsonLd({ url: site.canonicalBase, name: site.title, description }),
  buildPersonJsonLd({
    url: site.canonicalBase,
    name: site.author,
    logoUrl: new URL("/icons/android-chrome-512x512.png", site.canonicalBase).toString(),
    email: site.email,
    // "sameAs" hilft Suchmaschinen beim Zuordnen deiner Profile.
    // SEO-clean: bewusst nur öffentliche Profil-URLs (z. B. GitHub + LinkedIn).
    sameAs: sameAsLinks,
  }),
  buildWebPageJsonLd({
    url: canonicalUrl,
    name: title,
    description,
    isPartOf: site.canonicalBase,
  }),
];

const extraSchemas = (Astro.props as Props).jsonLd;
const allSchemas = Array.isArray(extraSchemas)
  ? [...baseSchemas, ...extraSchemas]
  : extraSchemas
    ? [...baseSchemas, extraSchemas]
    : baseSchemas;
---
<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />

    <!-- Tabler Icons (SVG Sprite) -->
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>{title}</title>

    <meta name="author" content={site.author} />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />

    <!-- Theme-Color (Dark zuerst) -->
    <meta name="theme-color" content="#0b0b12" />

    <script is:inline>
      // Aktiviert JS-optimierte Styles, ohne das No-JS Rendering zu zerstören
      document.documentElement.dataset.js = "true";
    </script>

    <!-- Fonts werden lokal via Fontsource geladen (siehe Frontmatter) -->

    <!-- Globale Styles werden über Astro importiert (siehe Frontmatter) -->

    <!-- Hero-Bild: siehe HeroSection (<Image priority />) -->

    <!-- Open Graph -->
    <meta property="og:site_name" content={site.domain} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:width" content="512" />
    <meta property="og:image:height" content="512" />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:alt" content={title} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta name="twitter:image:alt" content={title} />

    <!-- Sitemap-Hinweis (die Datei wird beim Build von @astrojs/sitemap erzeugt) -->
    <link rel="sitemap" href="/sitemap-index.xml" />

    <!-- Favicons / App-Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <!-- Strukturierte Daten (JSON-LD) -->
    <JsonLd data={allSchemas} />

    <slot name="head" />
  </head>

  <body>
    <!-- Scroll-Fortschritt (immer über allem, oberhalb der Navbar) -->
    <div id="scrollProgressWrap" class="fixed inset-x-0 top-0 z-[100] pointer-events-none">
      <div class="h-[1px] w-full bg-border/50">
        <div
          id="scrollProgressFill"
          class="h-full w-0 bg-gradient-to-r from-accent/95 via-accent2/95 to-accent/95 shadow-[0_0_18px_hsl(var(--accent)/0.35)]"></div>
      </div>
    </div>

    <!-- Hintergrund-Blobs (Artboard/Editorial-Feeling) -->
    <div aria-hidden="true" class="fixed inset-0 -z-10 overflow-hidden">
      <div class="absolute -top-48 -left-64 h-[520px] w-[520px] rounded-full bg-accent/12 blur-3xl blob-float-a"></div>
      <div class="absolute top-[18%] -right-72 h-[620px] w-[620px] rounded-full bg-accent2/10 blur-3xl blob-float-b"></div>
      <div class="absolute bottom-[-220px] left-[10%] h-[520px] w-[520px] rounded-full bg-accent/10 blur-3xl blob-float-c"></div>
      <div class="absolute inset-0 bg-gradient-to-b from-bg/30 via-bg to-bg"></div>
      <div class="absolute inset-0 pointer-events-none [box-shadow:inset_0_0_120px_rgba(0,0,0,0.55)]"></div>
    </div>

    <div class="grain" aria-hidden="true"></div>

    <slot />

    <!-- UI-Skripte (gebundelt) -->
    <script src="../scripts/client.ts"></script>

  </body>
</html>
